steps:
  build_image:
    image: quay.io/buildah/stable
    privileged: true
    environment:
      REGISTRY: harbor.anrostech.com
      IMAGE_BASE: anros/crm-back
      REGISTRY_USER:
        from_secret: registry_user
      REGISTRY_PASS:
        from_secret: registry_pass
    commands:
      - IMAGE_TAG=${CI_PIPELINE_CREATED}
      - echo "Logging into Harbor..."
      - buildah login $REGISTRY -u "$REGISTRY_USER" -p "$REGISTRY_PASS"

      - echo "Build both images in parallel"
      - buildah build -f docker/svc/Dockerfile --cache-from $REGISTRY/$IMAGE_BASE-svc --layers --cache-to $REGISTRY/$IMAGE_BASE-svc -t $REGISTRY/$IMAGE_BASE-svc:$IMAGE_TAG . &
      - buildah build -f docker/nginx/Dockerfile --cache-from $REGISTRY/$IMAGE_BASE-nginx --layers --cache-to $REGISTRY/$IMAGE_BASE-nginx -t $REGISTRY/$IMAGE_BASE-nginx:$IMAGE_TAG . &
      - wait

      - echo "Push both images in parallel"
      - buildah push $REGISTRY/$IMAGE_BASE-svc:$IMAGE_TAG &
      - buildah push $REGISTRY/$IMAGE_BASE-nginx:$IMAGE_TAG &
      - wait

  update_deployment_repo:
    image: alpine/git
    depends_on:
      - build_image
    environment:
      GIT_TOKEN:
        from_secret: git_token
      GIT_OWNER: marknguyenanl
      GIT_REPO: rr
      GIT_URL: github.com
    commands:
      - IMAGE_TAG=${CI_PIPELINE_CREATED}
      # Clone repo
      - git clone https://$GIT_TOKEN@$GIT_URL/$GIT_OWNER/$GIT_REPO
      - cd rr

      # Git identity
      - git config user.name "anrostech-bot"
      - git config user.email "ci@anrostech.com"

      # Sync main
      - git checkout main
      - git pull --rebase origin main

      # Create branch safely
      - |
        FILES=$(grep -rl "name: crm-back" . || true)
        for f in $FILES; do
          sed -i -E 's|(image: harbor\.anrostech\.com/anros/crm-back-svc:)[^[:space:]]+|\1'"$IMAGE_TAG"'|' "$f"
          sed -i -E 's|(image: harbor\.anrostech\.com/anros/crm-back-nginx:)[^[:space:]]+|\1'"$IMAGE_TAG"'|' "$f"
        done
      - |
        if git diff --quiet; then
          echo "âœ… No changes detected, skipping commit"
          exit 0
        fi

        git add $FILES
        git commit -m "CI: Update crm-back-svc and crm-back-nginx image to $IMAGE_TAG"

      # Push branch
      - git push origin main --force

